\RequirePackage{fancyhdr}         % Adaptation of the footers
\RequirePackage{tikz}            % For drawing
\RequirePackage{etoolbox}        % For \apptocmd
\RequirePackage{rotating}        % For vertical text
\RequirePackage{hyperref}        % Needed for \Hy@org@chapter
\RequirePackage{xstring}         % Needed for \ifthenelse

% Setup for custom footer
\pagestyle{fancy}

\newlength{\nobgfooterheight}
\setlength{\nobgfooterheight}{\paperheight}
\addtolength{\nobgfooterheight}{-1in}
\addtolength{\nobgfooterheight}{-\topmargin}
\addtolength{\nobgfooterheight}{-\headheight}
\addtolength{\nobgfooterheight}{-\headsep}
\addtolength{\nobgfooterheight}{-\textheight}
\addtolength{\nobgfooterheight}{-\footskip}

\newcommand{\background}{book/img/background}
\newcommand{\backgroundl}{\background}
\newcommand{\backgroundr}{\background}

\newcommand{\sidetocxshift}{-0.0cm}
\newcommand{\sidetocyshift}{-2.3cm}
\newcommand{\sidetocwidth}{3.25cm}
\newcommand{\sidetocheight}{22.5cm}

\newcommand{\footerPageXShift}{1.25cm}
\newcommand{\footerPageYShift}{1.0cm}

% Two versions of chapter list:
% 1. loaded from .stc file (for display)
% 2. built during document processing (to be saved)
\newcommand{\displaychapterlist}{} % Version loaded from .stc file
\newcommand{\currentchapter}{}

\newcommand{\sidetocitem}[1]{%
  \listgadd{\displaychapterlist}{#1}%
  \typeout{sidetocitem - #1}%
}

% Command to add a chapter to the build list
\newcommand{\addtochapterlist}[1]{%
  \addtocontents{toc}{\protect\sidetocitem {#1}}%
  \gdef\currentchapter{#1}%
}

% Apply modification to the original chapter command
\apptocmd{\Hy@org@chapter}{%
  \addtochapterlist{#2}%
}{}{}

% New chapter style that don't have number but included in toc and side-toc
\newcommand{\schapter}[1]{%
  \chapter*{#1}%
  \addtochapterlist{#1}%
  \addcontentsline{toc}{chapter}{#1}%
}

% Commands to visualize items of side TOC

\newcommand{\sideTocChapterFormat}[2]{%
  \parbox%
    {\sidetocwidth}%
    {\pfSideTocFont\color{#1}#2}%
}

\newcommand{\sideTocChapterDefault}[1]{%
  \setlength{\fboxrule}{0pt}%
  \framebox{%
   \sideTocChapterFormat{sideTocText}{#1}%
  }%
  \par%
  % \pfSideTocFont\color{sideTocText}#1\par
}
\newcommand{\sideTocChapterCurrent}[1]{%
  \colorbox{sideTocCurrentBackground}{%
   \sideTocChapterFormat{sideTocCurrentText}{#1}%
  }%
  \par%
  % \pfSideTocFont\color{sideTocCurrentText}#1\par
}
% \newcommand{\sideTocChapterCurrent}[1]{\colorbox{sideTocCurrentBackground}{\sideTocChapterFormat{sideTocCurrentText}{#1}}}
% \newcommand{\sideTocChapterCurrent}[1]{\colorbox{sideTocCurrentBackground}{\parbox{\sidetocwidth}{\pfSideTocFont\color{sideTocCurrentText}#1}}}

\renewcommand{\headrulewidth}{0.0pt} %no rule for header
\renewcommand{\footrulewidth}{0.0pt} %no rule for footer

\fancyhf{} % clear all headers and footers

\fancyhead[O]{
  \begin{tikzpicture}[remember picture,overlay]
    \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundr}};

    \node[anchor=north east, inner sep=0pt, xshift=\sidetocxshift, yshift=\sidetocyshift] at (current page.north east) {%
      \begin{minipage}[t][\sidetocheight]{\sidetocwidth}%
        \renewcommand*{\do}[1]{%
          \IfStrEq%
            {##1}%
            {\currentchapter}%
            {\sideTocChapterCurrent{##1}}%
            {\sideTocChapterDefault{##1}}%
        }%
        \dolistloop{\displaychapterlist}%
      \end{minipage}%
    };%
  \end{tikzpicture}%
}

\fancyhead[E]{
  \begin{tikzpicture}[remember picture,overlay]
    \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundl}};
  \end{tikzpicture}
}

\fancyfoot[LE]{
  \begin{tikzpicture}[remember picture,overlay]
    % \node[xscale=-1,inner sep=0pt,anchor=south,nearly opaque] at (current page.south) {\includegraphics[width=\paperwidth,height=43pt]{book/img/footerscroll}};
    \node[xshift=\footerPageXShift,yshift=\footerPageYShift] at (current page.south west) {\pfFooterFont\textcolor{pfFooterColor}{\thepage}};
    % \node[anchor=south west,xshift=\marginparwidth+\marginparpush,yshift=23pt] at (current page.south west) {\pfFooterFont{\textcolor{pfFooterColor}{\nouppercase\leftmark}}};
  \end{tikzpicture}
}

\fancyfoot[RO]{
  \begin{tikzpicture}[remember picture,overlay]
    % \node[inner sep=0pt,anchor=south,nearly opaque] at (current page.south) {\includegraphics[width=\paperwidth,height=43pt]{book/img/footerscroll}};
    \node[xshift=-\footerPageXShift,yshift=\footerPageYShift] at (current page.south east) {\pfFooterFont\textcolor{pfFooterColor}{\thepage}};
    % \node[anchor=south east,xshift=-\marginparwidth-\marginparpush,yshift=23pt] at (current page.south east) {\pfFooterFont{\textcolor{pfFooterColor}{\nouppercase\leftmark}}};
  \end{tikzpicture}
}

\fancypagestyle{plain}{}

\fancypagestyle{part}{
  \fancyhf{} % clear all headers and footers
  \fancyhead[O]{
    \begin{tikzpicture}[remember picture,overlay]
      \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundr}};
      % \node[inner sep=0pt,anchor=north] at (current page.north) {\includegraphics[width=\paperwidth]{book/img/header-part-circ}};
      % \node[inner sep=0pt,anchor=north west] at (current page.north west) {\includegraphics[width=.5\paperwidth]{book/img/header-part}};
      % \node[xscale=-1, inner sep=0pt, anchor=north west] at (current page.north east) {\includegraphics[width=.5\paperwidth]{book/img/header-part}};
    \end{tikzpicture}
  }
}

\fancypagestyle{part}{
  \fancyhf{} % clear all headers and footers
  \fancyhead[E]{
    \begin{tikzpicture}[remember picture,overlay]
      \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundl}};
      % \node[inner sep=0pt,anchor=north] at (current page.north) {\includegraphics[width=\paperwidth]{book/img/header-part-circ}};
      % \node[inner sep=0pt,anchor=north west] at (current page.north west) {\includegraphics[width=.5\paperwidth]{book/img/header-part}};
      % \node[xscale=-1, inner sep=0pt, anchor=north west] at (current page.north east) {\includegraphics[width=.5\paperwidth]{book/img/header-part}};
    \end{tikzpicture}
  }
}

\fancypagestyle{chapter}{
  \thispagestyle{fancy}
  \fancyhead[O]{
    \begin{tikzpicture}[remember picture,overlay]
      \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundr}};
      % \node[inner sep=0pt,anchor=north west] at (current page.north west) {\includegraphics[width=.5\paperwidth]{book/img/header-chapter}};
      % \node[xscale=-1, inner sep=0pt, anchor=north west] at (current page.north east) {\includegraphics[width=.5\paperwidth]{book/img/header-chapter}};
    \end{tikzpicture}
  }
}

\fancypagestyle{chapter}{
  \thispagestyle{fancy}
  \fancyhead[E]{
    \begin{tikzpicture}[remember picture,overlay]
      \node[inner sep=0pt] at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{\backgroundl}};
      % \node[inner sep=0pt,anchor=north west] at (current page.north west) {\includegraphics[width=.5\paperwidth]{book/img/header-chapter}};
      % \node[xscale=-1, inner sep=0pt, anchor=north west] at (current page.north east) {\includegraphics[width=.5\paperwidth]{book/img/header-chapter}};
    \end{tikzpicture}
  }
}