\RequirePackage{graphicx}
\RequirePackage[strict]{changepage}
\RequirePackage{afterpage}

\newenvironment{figurehere}
  {\def\@captype{figure}}
  {}

\def\pf@backgroundArt{}

% After page that
%   - Works with twoside
%   - Makes \aftergroup
\newcommand{\pf@afterpage}[2][]{
  \if@twoside%
    \afterpage{%
      \if@firstcolumn%
        \typeout{pf@afterpage - executing "#1"}%
        % \aftergroup#2%
        #2%
      \else%
        \typeout{pf@afterpage - not ready to execute "#1" (ended column, not page)}%
        \pf@afterpage[#1]{#2}%
      \fi%
    }%
  \else%
    \afterpage{%
      \typeout{pf@afterpage - executing "#1"}%
      % \aftergroup#2%
      #2%
    }%
  \fi%
}

% cover
\newkeycommand\pfMakeCover[
  image=,
  logo=book/Paizo/Pathfinder-Second-Edition-Compatibility-Color,
  title=Title,
  subtitle=subtitle,
]{
  % \onecolumn
  \thispagestyle{artpage}
  \def\pf@backgroundArt{\commandkey{image}}

  \newgeometry{left=1in,right=1in,top=1in,bottom=1in}
  % \AddToHookNext{shipout/background}{
  %   \tikz[remember picture,overlay] \node[inner sep=0pt] at (current page.center){\includegraphics[width=\paperwidth,height=\paperheight]{\commandkey{image}}};
  % }
  \begin{center}
    \vspace*{-15mm}\includegraphics[width=5in]{\commandkey{logo}}\\*\vspace*{15mm}
    \fontsize{48pt}{48pt}
    \selectfont
    \fillstroke{[1]}{[0]}{1.5}{\MakeUppercase{\commandkey{title}}}\\*
    \normalfont\normalsize%\includegraphics[width=.5\paperwidth]{book/img/separator}
    \LARGE\vfill
    \fontsize{18pt}{18pt}
    \fillstroke{[1]}{[0]}{0.5}{\textbf{\commandkey{subtitle}}}
  \end{center}
  % \clearpage
  \restoregeometry
  % \thispagestyle{}
  % \twocolumn%
}

% Full page art
\newcommand{\pfPageArt}[1]{%
  \clearpage
  \thispagestyle{artpage}
  \def\pf@backgroundArt{#1}
  % \thispagestyle{empty}
  \newgeometry{left=1in,right=1in,top=1in,bottom=1in}
  1
  % \def\pf@backgroundArt{#1}
  % \AddToHookNext{shipout/background}{
  %   \tikz[remember picture,overlay] \node[inner sep=0pt] at (current page.center)%
  %     {\includegraphics[width=\paperwidth,height=\paperheight]{#1}};
  % }
  \restoregeometry
}

% Splash art
\newcommand{\pf@splashImage}{}

\newcommand{\pf@updateSplashDimenstions}{
  \iftoggle{side-toc}{
    \ifnumodd{\thepage}{
      % \vspace*{-0.8cm}
      % \hspace*{-2.2cm}
      \def\splashAnchor{north west}
      \def\splashShiftX{0pt}
      \def\splashShiftY{-2cm}
      \def\splashWidth{\paperwidth-3.1cm}
    }{
      % \vspace*{-0.8cm}
      % \hspace*{-1.5cm}
      \def\splashAnchor{north east}
      \def\splashShiftX{0cm}
      \def\splashShiftY{-2cm}
      \def\splashWidth{\paperwidth-2.5cm}
    }
  }{
    % \vspace*{-1.5cm}
    % \hspace*{-1.5cm}
    \def\splashAnchor{north}
    \def\splashShiftX{0pt}
    \def\splashShiftY{0pt}
    \def\splashWidth{\paperwidth}
  }
}

\newcommand{\pf@renderSplashImage}{  
  \pf@updateSplashDimenstions
  \typeout{Rendering splash \pf@splashImage}
  \node[inner sep=0pt,anchor=\splashAnchor,xshift=\splashShiftX,yshift=\splashShiftY] at (current page.\splashAnchor) {%
    \includegraphics[width=\splashWidth,keepaspectratio]{\pf@splashImage}%
  };%
}
  
\newcommand{\pf@addPageSplashNow}[2]{
  \global\def\pf@splashImage{#1}
  % \renewcommand{\pf@splashImage}{#1}

  \typeout{Splash 1=\pf@splashImage\ 2=#2}
  
  \newgeometry{top=#2}%
  \makegeometryglobal%
  \thispagestyle{splash}%

  \pf@afterpage[restoregeometry]{\restoregeometry\makegeometryglobal}
  % \afterpage{\restoregeometry\makegeometryglobal}
}

\newcommand{\pf@nextSplash}{}

\newcommand{\pf@addPageSplash}[2]{
  \renewcommand{\pf@nextSplash}{\pf@addPageSplashNow{#1}{#2}}
  % \pf@afterpage[pf@nextSplash]{\pf@nextSplash}%
  \pf@afterpage[pf@nextSplash]{\pf@nextSplash}%
  \typeout{Splash next page 1=#1\ 2=#2}
}

\newcommand{\addPageSplash}{\@ifstar{\pf@addPageSplashNow}{\pf@addPageSplash}}

% Big art
\newlength{\pfhmargin}
\newcommand*{\pfBigArt}[2]{%
  \checkoddpage
  \ifoddpage
    \setlength{\pfhmargin}{\dimexpr 1in+\hoffset+\oddsidemargin+4pt \relax}
  \else
    \setlength{\pfhmargin}{\dimexpr 1in+\hoffset+\evensidemargin+4pt \relax}

  \fi
  \begin{figure*}[#1!]
    \centering
    \if #1t
      \vspace*{-\dimexpr1in+\voffset+\topmargin+\headheight+\headsep \relax}
    \fi

     \makebox[\paperwidth+1pt][l]{
      \hskip-\pfhmargin \relax
      \includegraphics[width=\paperwidth+1pt]{#2}
    }
    \if #1b
      \vspace*{-\dimexpr\paperheight-\textheight-1in+13pt-\voffset-\topmargin-\headheight-\headsep\relax}
    \fi

  \end{figure*}
}

% Art
\newcommand{\pfArt}[2][0.8]{%
  \begin{figurehere}%
    \centering%
    \includegraphics[width=#1\linewidth]{#2}%
  \end{figurehere}%
}

% Wrap art
\newcommand{\pfWrapArt}[2][0.8]{%
  \setlength{\unitlength}{#1\linewidth}%
  \setlength{\intextsep}{-1ex}%
  \docolaction{% left if we're in the left column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{l}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }{% left if we're in the middle column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{l}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }{% right if we're in the right column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{r}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }%
}

% There is also an \includesvg command from the svg package...
% Black magic from StackOverflow
\newcommand*\pfInlineArt[2][1.0]{%
  \raisebox{-0.2\dimexpr#1\baselineskip}{%
      \includegraphics[
        height=#1\baselineskip,
        keepaspectratio,
      ]{#2}%
  }
}




\NewDocumentCommand{\makegeometryglobal}{ }
{%
  %% lengths saved in \Gm@save and set by \Gm@restore
  \global\paperwidth=\paperwidth%
  \global\paperheight=\paperheight%
  \global\textwidth=\textwidth%
  \global\textheight=\textheight%
  \global\evensidemargin=\evensidemargin%
  \global\oddsidemargin=\oddsidemargin%
  \global\topmargin=\topmargin%
  \global\headheight=\headheight%
  \global\headsep=\headsep%
  \global\topskip=\topskip%
  \global\footskip=\footskip%
  \global\baselineskip=\baselineskip%
  \global\marginparsep=\marginparsep%
  \global\marginparwidth=\marginparwidth%
  \global\columnsep=\columnsep%
  \global\hoffset=\hoffset%
  \global\voffset=\voffset%
  \global\Gm@layoutwidth=\Gm@layoutwidth%
  \global\Gm@layoutheight=\Gm@layoutheight%
  \global\Gm@layouthoffset=\Gm@layouthoffset%
  \global\Gm@layoutvoffset=\Gm@layoutvoffset%
  %% booleans saved in \Gm@save and set by \Gm@restore
  \global\let\if@twocolumn\if@twocolumn%
  \global\let\if@twoside\if@twoside%
  \global\let\if@mparswitch\if@mparswitch%
  \global\let\if@reversemargin\if@reversemargin%
  %% lengths set in \Gm@changelayout
  \global\@colht=\@colht%
  \global\@colroom=\@colroom%
  \global\vsize=\vsize%
  \global\columnwidth=\columnwidth%
  \global\hsize=\hsize%
  \global\linewidth=\linewidth%
  %% boolean set in \Gm@changelayout
  \global\let\if@firstcolumn\if@firstcolumn%
}