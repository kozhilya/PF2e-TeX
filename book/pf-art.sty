\RequirePackage{graphicx}
% \RequirePackage{dblfloatfix}
\RequirePackage[strict]{changepage}

\makeatletter
\newenvironment{figurehere}
  {\def\@captype{figure}}
  {}
\makeatother


% cover
\newkeycommand\pfMakeCover[
  image=,
  logo=book/Paizo/Pathfinder-Second-Edition-Compatibility-Color,
  title=Title,
  subtitle=subtitle,
]{
  % \onecolumn
  \thispagestyle{empty}
  \newgeometry{left=1in,right=1in,top=1in,bottom=1in}
  \AddToHookNext{shipout/background}{
    \tikz[remember picture,overlay] \node[inner sep=0pt] at (current page.center){\includegraphics[width=\paperwidth,height=\paperheight]{\commandkey{image}}};
  }
  \begin{center}
    \vspace*{-15mm}\includegraphics[width=5in]{\commandkey{logo}}\\*\vspace*{15mm}
    \fontsize{48pt}{48pt}
    \selectfont
    \fillstroke{[1]}{[0]}{1.5}{\MakeUppercase{\commandkey{title}}}\\*
    \normalfont\normalsize%\includegraphics[width=.5\paperwidth]{book/img/separator}
    \LARGE\vfill
    \fontsize{18pt}{18pt}
    \fillstroke{[1]}{[0]}{0.5}{\textbf{\commandkey{subtitle}}}
  \end{center}
  % \clearpage
  \restoregeometry
  % \twocolumn%
}

% Logo Only Cover
\newkeycommand\pfMakeLogoCover[
  image=,
]{
  \pagenumbering{alph}
  % \onecolumn
  \thispagestyle{empty}
  \AddThispageHook{
    \tikz[remember picture,overlay] \node[inner sep=0pt] at (current page.center){\includegraphics[width=\paperwidth,height=\paperheight]{\commandkey{image}}};
  }
  \begin{center}
    % This is here so the cover actually shows up.
    % Do not remove
  \end{center}
  \clearpage
  \pagenumbering{roman}
  \setcounter{page}{0} %% Page zero is effectively the inside cover of the book.  It's also the coolest number!
  % \twocolumn%
}

% Splash art
\newcommand{\renderSplashImage}{}
  
\newcommand{\addPageSplash}[1]{%
  \thispagestyle{splash}%
  \iftoggle{side-toc}{
    \ifnumodd{\thepage}{
      % \vspace*{-0.8cm}
      % \hspace*{-2.2cm}
      \def\splashAnchor{north west}
      \def\splashShiftX{0pt}
      \def\splashShiftY{-2cm}
      \def\splashWidth{\paperwidth-3.1cm}
    }{
      % \vspace*{-0.8cm}
      % \hspace*{-1.5cm}
      \def\splashAnchor{north east}
      \def\splashShiftX{0cm}
      \def\splashShiftY{-2cm}
      \def\splashWidth{\paperwidth-2.5cm}
    }
  }{
    % \vspace*{-1.5cm}
    % \hspace*{-1.5cm}
    \def\splashAnchor{north}
    \def\splashShiftX{0pt}
    \def\splashShiftY{0pt}
    \def\splashWidth{\paperwidth}
  }
  \def\splashImage{#1}
  \renewcommand{\renderSplashImage}{
    \node[inner sep=0pt,anchor=\splashAnchor,xshift=\splashShiftX,yshift=\splashShiftY] at (current page.\splashAnchor) {%
      \includegraphics[width=\splashWidth,keepaspectratio]{\splashImage}%
    };%
  }
  % \begin{figure*}[t]
  %   \vspace*{#2}
  % \end{figure*}
}


% Big art
\newlength{\pfhmargin}
\newcommand*{\pfBigArt}[2]{%
  \checkoddpage
  \ifoddpage
    \setlength{\pfhmargin}{\dimexpr 1in+\hoffset+\oddsidemargin+4pt \relax}
  \else
    \setlength{\pfhmargin}{\dimexpr 1in+\hoffset+\evensidemargin+4pt \relax}

  \fi
  \begin{figure*}[#1!]
    \centering
    \if #1t
      \vspace*{-\dimexpr1in+\voffset+\topmargin+\headheight+\headsep \relax}
    \fi

     \makebox[\paperwidth+1pt][l]{
      \hskip-\pfhmargin \relax
      \includegraphics[width=\paperwidth+1pt]{#2}
    }
    \if #1b
      \vspace*{-\dimexpr\paperheight-\textheight-1in+13pt-\voffset-\topmargin-\headheight-\headsep\relax}
    \fi

  \end{figure*}
}

% Art
\newcommand{\pfArt}[2][0.8]{%
  \begin{figurehere}%
    \centering%
    \includegraphics[width=#1\linewidth]{#2}%
  \end{figurehere}%
}

% Wrap art
\newcommand{\pfWrapArt}[2][0.8]{%
  \setlength{\unitlength}{#1\linewidth}%
  \setlength{\intextsep}{-1ex}%
  \docolaction{% left if we're in the left column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{l}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }{% left if we're in the middle column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{l}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }{% right if we're in the right column
    \setlength{\columnsep}{0em}%
    \begin{wrapfigure}{r}{\unitlength}%
      \centering%
      \includegraphics[width=\unitlength]{#2}%
      % \vspace{-2ex}%
    \end{wrapfigure}%
  }%
}

% There is also an \includesvg command from the svg package...
% Black magic from StackOverflow
\newcommand*\pfInlineArt[2][1.0]{%
  \raisebox{-0.2\dimexpr#1\baselineskip}{%
      \includegraphics[
        height=#1\baselineskip,
        keepaspectratio,
      ]{#2}%
  }
}
