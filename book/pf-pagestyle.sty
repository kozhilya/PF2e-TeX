\RequirePackage{fancyhdr}         % Adaptation of the footers
\RequirePackage{tikz}            % For drawing
\RequirePackage{etoolbox}        % For \apptocmd
\RequirePackage{rotating}        % For vertical text
\RequirePackage{hyperref}        % Needed for \Hy@org@chapter
\RequirePackage{xstring}         % Needed for \ifthenelse

% Setup for custom footer
\pagestyle{fancy}

\newlength{\nobgfooterheight}
\setlength{\nobgfooterheight}{\paperheight}
\addtolength{\nobgfooterheight}{-1in}
\addtolength{\nobgfooterheight}{-\topmargin}
\addtolength{\nobgfooterheight}{-\headheight}
\addtolength{\nobgfooterheight}{-\headsep}
\addtolength{\nobgfooterheight}{-\textheight}
\addtolength{\nobgfooterheight}{-\footskip}

\newcommand{\background}{book/img/background}
\newcommand{\backgroundl}{book/img/pageleft}
\newcommand{\backgroundr}{book/img/pageright}

\newcommand{\footerPageXShift}{1.25cm}
\newcommand{\footerPageYShift}{1.0cm}

\renewcommand{\headrulewidth}{0.0pt} %no rule for header
\renewcommand{\footrulewidth}{0.0pt} %no rule for footer

\newcommand{\pf@renderBackground}[1]{
  \node[inner sep=0pt,anchor=center] at (current page.center) {\includegraphics[width=\pf@backgroundScale\paperwidth,height=\pf@backgroundScale\paperheight]{#1}};
}
\newcommand{\pf@renderPageNumber}{\pfPageNumberFont\textcolor{pfFooterColor}{\thepage}}
\newcommand{\pf@backgroundScale}{1.0}

\fancyhf{} % clear all headers and footers

\fancyhead[O]{
  \begin{tikzpicture}[remember picture,overlay]
    \pf@renderBackground{\backgroundr}
    \node[xshift=-\footerPageXShift,yshift=\footerPageYShift] at (current page.south east) {\pf@renderPageNumber};
    \pf@renderSideTocChapter
  \end{tikzpicture}%
}

\fancyhead[E]{
  \begin{tikzpicture}[remember picture,overlay]
    \pf@renderBackground{\backgroundl}
    \node[xshift=\footerPageXShift,yshift=\footerPageYShift] at (current page.south west) {\pf@renderPageNumber};
  \end{tikzpicture}
}

\fancypagestyle{plain}{}

\fancypagestyle{empty}{}

\fancypagestyle{artpage}{
  \fancyhf{} % clear all headers and footers

  \fancyhead[O]{
    \begin{tikzpicture}[remember picture,overlay]
      \pf@renderBackground{\pf@backgroundArt}
      \pf@renderSideTocChapter
    \end{tikzpicture}
  }

  \fancyhead[E]{
    \begin{tikzpicture}[remember picture,overlay]
      \pf@renderBackground{\pf@backgroundArt}
    \end{tikzpicture}
  }
}

\fancypagestyle{splash}{
  \fancyhf{} % clear all headers and footers

  % \fancyheadoffset{O,E}{\pf@splashSpace}

  \fancyhead[O]{
    \begin{tikzpicture}[remember picture,overlay]
      \pf@renderSplashImage
      \pf@renderBackground{\backgroundr}
      \node[xshift=-\footerPageXShift,yshift=\footerPageYShift] at (current page.south east) {\pf@renderPageNumber\color{white}!!!O};
      \pf@renderSideTocChapter
    \end{tikzpicture}
  }

  \fancyhead[E]{
    \begin{tikzpicture}[remember picture,overlay]
      \pf@renderSplashImage
      \pf@renderBackground{\backgroundl}
      \node[xshift=\footerPageXShift,yshift=\footerPageYShift] at (current page.south west) {\pf@renderPageNumber\color{white}!!!E};
    \end{tikzpicture}
  }
}

